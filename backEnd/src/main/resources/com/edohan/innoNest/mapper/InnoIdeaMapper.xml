<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edohan.innoNest.mapper.InnoIdeaMapper">

    <!-- 아이디어 목록 조회 -->
    <select id="innoIdeaList" resultType="java.util.Map">
        SELECT 
            A.ID                AS ID, 
            A.TITLE             AS TITLE, 
            A.CONTENT           AS CONTENT, 
            A.WRITER            AS WRITER, 
            A.TAGS              AS TAGS, 
            A.LIKE_COUNT        AS LIKE_COUNT, 
            A.DISLIKE_COUNT     AS DISLIKE_COUNT, 
            A.WRITERDATE        AS WRITERDATE, 
            A.UPDATEDATE        AS UPDATEDATE, 
            A.VIEW_COUNT        AS VIEW_COUNT, 
            A.CATEGORY          AS CATEGORY, 
            A.STATUS            AS STATUS
        FROM 
            TB_IDEA A
        WHERE A.STATUS = 'ACTIVE'
        ORDER BY 
            A.WRITERDATE DESC
    </select>
    
    <!-- 아이디어 세부 정보 조회 -->
    <select id="getIdeaDetail" parameterType="int" resultType="map">
        SELECT 
        A.ID AS ID,
        A.TITLE AS TITLE,
        A.CONTENT AS CONTENT,
        A.WRITER AS WRITER,
        A.TAGS AS TAGS,
        A.WRITERDATE AS WRITERDATE,
        A.UPDATEDATE AS UPDATEDATE,
        A.VIEW_COUNT AS VIEW_COUNT,
        A.CATEGORY AS CATEGORY,
        A.STATUS AS STATUS,
        IFNULL(L.LIKE_COUNT, 0) AS LIKE_COUNT,
        IFNULL(D.DISLIKE_COUNT, 0) AS DISLIKE_COUNT
    FROM 
        TB_IDEA A
    LEFT JOIN 
        (SELECT IDEA_ID, COUNT(*) AS LIKE_COUNT 
         FROM tb_reactions 
         WHERE REACTION_TYPE = 'LIKE' 
         GROUP BY IDEA_ID) L 
    ON A.ID = L.IDEA_ID
    LEFT JOIN 
        (SELECT IDEA_ID, COUNT(*) AS DISLIKE_COUNT 
         FROM tb_reactions 
         WHERE REACTION_TYPE = 'DISLIKE' 
         GROUP BY IDEA_ID) D 
    ON A.ID = D.IDEA_ID
    WHERE 
        A.ID = #{id}
    </select>

    <!-- 아이디어 저장 -->
    <insert id="saveIdea" parameterType="map">
        INSERT INTO TB_IDEA 
        (TITLE,
        CONTENT,
        WRITER,
        TAGS,
        CATEGORY,
        WRITERDATE,
        UPDATEDATE)
        VALUES 
        (#{title},
        #{content},
        #{userId},
        #{tags},
        #{category},
        NOW(),
        NOW())
    </insert>

    <!-- 아이디어 수정 -->
    <update id="updateIdea" parameterType="map">
        UPDATE TB_IDEA
        SET TITLE = #{title}
            , CONTENT = #{content}
            , UPDATEDATE = NOW()
        WHERE ID = #{id}
    </update>
    
    <!-- 아이디어 삭제 -->
    <delete id="deleteIdea" parameterType="int">
        DELETE FROM TB_IDEA
        WHERE ID = #{id}
    </delete>

    <!-- 아이디어 조회수 증가 -->
    <update id="incViewCount" parameterType="int">
        UPDATE TB_IDEA
        SET VIEW_COUNT = VIEW_COUNT + 1
        WHERE ID = #{id}
    </update>

    <!-- 반응 추가 및 수정 -->
    <insert id="addReaction" parameterType="map">
        INSERT INTO TB_REACTIONS 
        (MEMBER_ID
        , IDEA_ID
        , REACTION_TYPE)
        VALUES 
        (#{userId},
         #{ideaId},
         #{reactionType})
        ON DUPLICATE KEY UPDATE REACTION_TYPE = VALUES(REACTION_TYPE)
    </insert>

    <!-- 좋아요 반응 삭제 -->
    <delete id="removeLikeReaction" parameterType="map">
        DELETE FROM TB_REACTIONS
        WHERE MEMBER_ID = #{userId} 
            AND IDEA_ID = #{ideaId} 
            AND REACTION_TYPE = 'LIKE'
    </delete>

    <!-- 싫어요 반응 삭제 -->
    <delete id="removeDislikeReaction" parameterType="map">
        DELETE FROM TB_REACTIONS
        WHERE MEMBER_ID = #{userId} 
        AND IDEA_ID = #{ideaId} 
        AND REACTION_TYPE = 'DISLIKE'
    </delete>

    <!-- 아이디어 좋아요/싫어요 카운트 조회 -->
    <select id="getReactionCounts" parameterType="int" resultType="map">
        SELECT 
            IFNULL(SUM(CASE WHEN REACTION_TYPE = 'LIKE' THEN 1 ELSE 0 END), 0) AS LIKE_COUNT,
            IFNULL(SUM(CASE WHEN REACTION_TYPE = 'DISLIKE' THEN 1 ELSE 0 END), 0) AS DISLIKE_COUNT
        FROM 
            TB_REACTIONS
        WHERE 
            IDEA_ID = #{id}
    </select>

</mapper>
